<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MARSOL ¬∑ Cost Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif}
body{background:#f2f4f8;color:#1c1c1e}

/* SPLASH */
#splash{
  position:fixed;inset:0;
  background:linear-gradient(180deg,#0f4c75,#3282b8,#bbe1fa);
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  color:#fff;z-index:1000
}
#splash h1{font-size:32px;font-weight:700}
#splash p{margin-top:8px;opacity:.85}

/* LOGIN */
#login,#app{display:none;padding:20px}
.login-box{
  max-width:360px;margin:80px auto;
  background:#fff;border-radius:20px;
  padding:25px;box-shadow:0 10px 25px rgba(0,0,0,.1)
}
.login-box h2{text-align:center;margin-bottom:20px}
button{
  width:100%;padding:14px;border:none;
  border-radius:14px;font-weight:600;
  background:#007aff;color:#fff;margin-bottom:12px;
  cursor:pointer
}
button.secondary{
  background:#e5e5ea;color:#000
}
button.secondary.selected{
  background:#007aff;
  color:#fff;
  border:2px solid #0056cc;
}
#loginMsg{color:red;text-align:center;font-size:14px}

/* APP HEADER */
.user-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 15px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 5px 15px rgba(0,0,0,.06);
}

.view-toggle-btn {
  padding: 8px 16px;
  background: #34c759;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  margin-right: 10px;
}

.view-toggle-btn.conjunta {
  background: #af52de;
}

.recordatorios-btn {
  padding: 8px 16px;
  background: #ff9500;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  margin-right: 10px;
}

.logout-btn {
  padding: 8px 16px;
  background: #ff3b30;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
}

.user-badges {
  display: flex;
  gap: 8px;
  margin-top: 5px;
}

.user-badge {
  background: #e5f0ff;
  color: #007aff;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
}

/* MODALES */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #eee;
}

.modal-header h2 {
  margin: 0;
  color: #1c1c1e;
}

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.close-modal:hover {
  background: #f2f2f7;
}

.modal-body {
  padding: 20px;
}

/* CAMERA MODAL */
.camera-container {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

#cameraVideo {
  width: 100%;
  border-radius: 12px;
  background: #000;
}

.camera-controls {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
}

.capture-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #ff3b30;
  border: 4px solid white;
  box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
  cursor: pointer;
}

#capturedImage {
  width: 100%;
  border-radius: 12px;
  display: none;
}

/* FILTER CONTROLS */
.filter-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 8px 16px;
  background: #e5e5ea;
  color: #1c1c1e;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
}

.filter-btn.active {
  background: #007aff;
  color: white;
}

/* DASHBOARD */
h1{text-align:center;margin-bottom:20px}
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:15px;margin-bottom:25px
}
.card{
  border-radius:20px;padding:20px;color:#fff;
  box-shadow:0 10px 25px rgba(0,0,0,.08)
}
.ingreso{background:linear-gradient(135deg,#34c759,#2ecc71)}
.gasto{background:linear-gradient(135deg,#ff3b30,#ff6b6b)}
.saldo{background:linear-gradient(135deg,#007aff,#5ac8fa)}

/* FORM */
form{
  background:#fff;border-radius:20px;padding:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  margin-bottom:25px
}
 
.segmented{display:flex;background:#eee;border-radius:14px;margin-bottom:15px}
.segmented button{
  flex:1;border:none;padding:12px;
  background:none;font-weight:600;cursor:pointer
}
.segmented .active{background:#007aff;color:#fff}
 
input,select,textarea{
  width:100%;padding:14px;border-radius:14px;
  border:1px solid #ccc;margin-bottom:12px
}
 
.increment{
  background:#e5f0ff;color:#007aff;
  border:none;padding:10px;border-radius:12px;
  cursor:pointer;font-weight:600;margin-bottom:12px
}

.photo-btn {
  background: #34c759;
  color: white;
  border: none;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.photo-preview {
  width: 100px;
  height: 100px;
  border-radius: 10px;
  object-fit: cover;
  border: 2px solid #ccc;
  margin-bottom: 12px;
  display: none;
}
 
.submit{
  width:100%;padding:14px;
  border:none;border-radius:16px;
  background:linear-gradient(135deg,#007aff,#5ac8fa);
  color:#fff;font-weight:600;font-size:16px
}

/* CHART & MOVEMENTS */
canvas{
  background:#fff;border-radius:20px;
  padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.08);
  margin-bottom:25px
}
 
ul{list-style:none}
li{
  background:#fff;border-radius:16px;
  padding:15px;margin-bottom:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.06);
  position: relative;
}

li.movimiento-eliminado {
  opacity: 0.6;
  background: #f9f9f9;
  border-left: 5px solid #cccccc;
}

li.movimiento-eliminado::after {
  content: "‚ùå ELIMINADO";
  position: absolute;
  top: 15px;
  right: 15px;
  background: #ff3b30;
  color: white;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: bold;
}

li.ingreso{border-left:5px solid #34c759}
li.gasto{border-left:5px solid #ff3b30}
small{color:#666}
.user-tag {
  display: inline-block;
  background: #e5e5ea;
  color: #000;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  margin-left: 5px;
  font-weight: 600;
}

.movement-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.delete-movement-btn {
  background: #ff3b30;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}

.restore-movement-btn {
  background: #34c759;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}

.view-photo-btn {
  background: #007aff;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  display: none;
}

.movement-has-photo .view-photo-btn {
  display: inline-block;
}

/* REMINDERS LIST */
.reminders-list {
  margin-top: 20px;
  max-height: 400px;
  overflow-y: auto;
}

.reminder-item {
  background: #fff;
  border-radius: 16px;
  padding: 15px;
  margin-bottom: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,.06);
  border-left: 5px solid #ff9500;
  transition: transform 0.2s ease;
}

.reminder-item:hover {
  transform: translateY(-2px);
}

.reminder-item.vencido {
  border-left: 5px solid #ff3b30;
  background: #fff5f5;
}

.reminder-item.proximo {
  border-left: 5px solid #ff9500;
  background: #fff9f0;
}

.reminder-item.normal {
  border-left: 5px solid #34c759;
  background: #f8fff9;
}

.reminder-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.reminder-type {
  background: #ff9500;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.reminder-dates {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  font-size: 12px;
}

.reminder-date {
  color: #666;
}

.reminder-due-date {
  font-weight: 600;
  margin-top: 2px;
}

.reminder-due-date.vencido {
  color: #ff3b30;
}

.reminder-due-date.proximo {
  color: #ff9500;
}

.reminder-due-date.normal {
  color: #34c759;
}

.reminder-text {
  color: #1c1c1e;
  line-height: 1.4;
  margin: 10px 0;
}

.reminder-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #f0f0f0;
}

.delete-reminder {
  background: #ff3b30;
  color: white;
  border: none;
  padding: 4px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}

.empty-reminders {
  text-align: center;
  color: #666;
  padding: 20px;
  font-style: italic;
}

/* NOTIFICATION */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #34c759;
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,.2);
  z-index: 1000;
  display: none;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* PHOTO VIEWER */
.photo-viewer {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

.photo-viewer img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
}

.close-photo-viewer {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #ff3b30;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>

<!-- CAMERA MODAL -->
<div class="modal-overlay" id="cameraModal">
  <div class="modal">
    <div class="modal-header">
      <h2>üì∏ Tomar foto de factura</h2>
      <button class="close-modal" onclick="closeCameraModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="camera-container">
        <video id="cameraVideo" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display:none"></canvas>
        <img id="capturedImage" alt="Foto capturada">
        
        <div class="camera-controls">
          <button class="capture-btn" id="captureBtn" onclick="capturePhoto()"></button>
        </div>
        
        <div style="margin-top: 20px; display: none;" id="photoActions">
          <button onclick="retakePhoto()" style="margin-right: 10px;">Tomar otra</button>
          <button onclick="usePhoto()">Usar esta foto</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PHOTO VIEWER -->
<div class="photo-viewer" id="photoViewer">
  <button class="close-photo-viewer" onclick="closePhotoViewer()">√ó</button>
  <img id="fullSizePhoto" alt="Foto completa">
</div>

<!-- MODAL RECORDATORIOS -->
<div class="modal-overlay" id="remindersModal">
  <div class="modal">
    <div class="modal-header">
      <h2>üìù Recordatorios</h2>
      <button class="close-modal" onclick="closeRemindersModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="reminderForm">
        <select id="reminderType" required>
          <option value="">Selecciona un tipo</option>
          <option value="Casa">üè† Casa</option>
          <option value="Estudio">üìö Estudio</option>
          <option value="Trabajo">üíº Trabajo</option>
          <option value="Familia">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</option>
          <option value="Viaje">‚úàÔ∏è Viaje</option>
          <option value="Entretenimiento">üé¨ Entretenimiento</option>
          <option value="Salud">üè• Salud</option>
          <option value="Finanzas">üí∞ Finanzas</option>
          <option value="Otro">üìå Otro</option>
        </select>
        
        <textarea 
          id="reminderText" 
          rows="4" 
          placeholder="Escribe tu recordatorio aqu√≠..."
          required
        ></textarea>
        
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1c1c1e;">
          Fecha de vencimiento (opcional):
        </label>
        <input 
          type="date" 
          id="reminderDueDate"
          min="2024-01-01"
          style="margin-bottom: 20px;"
        >
        
        <button type="submit" class="submit">Guardar Recordatorio</button>
      </form>
      
      <div class="filter-controls" id="reminderFilters">
        <button class="filter-btn active" onclick="filterReminders('criticos')">
          M√°s cr√≠ticos
        </button>
        <button class="filter-btn" onclick="filterReminders('todos')">
          Todos
        </button>
        <button class="filter-btn" onclick="filterReminders('vencidos')">
          Vencidos
        </button>
        <button class="filter-btn" onclick="filterReminders('proximos')">
          Pr√≥ximos
        </button>
        <button class="filter-btn" onclick="filterReminders('sinFecha')">
          Sin fecha
        </button>
      </div>
      
      <div class="reminders-list" id="remindersList">
        <!-- Los recordatorios se cargar√°n aqu√≠ -->
      </div>
    </div>
  </div>
</div>

<!-- SPLASH -->
<div id="splash">
  <h1>MarSol Cost Control</h1>
  <p>Versi√≥n 1.6 ¬∑ 2026</p>
</div>

<!-- LOGIN -->
<div id="login">
  <div class="login-box">
    <h2>Selecciona tu perfil</h2>
    <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">
      Haz clic en tu nombre para ingresar
    </p>

    <button class="secondary" id="btnAna" onclick="loginUser('ana')">Ana Mar√≠a</button>
    <button class="secondary" id="btnCamilo" onclick="loginUser('camilo')">Camilo Andr√©s</button>

    <p id="loginMsg"></p>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="user-info">
    <div>
      <h3 id="welcomeUser">Bienvenido/a</h3>
      <div class="user-badges" id="userBadges">
        <!-- Badges de usuarios activos se agregar√°n aqu√≠ -->
      </div>
    </div>
    <div>
      <button class="view-toggle-btn" id="viewToggleBtn" onclick="toggleView()">Visual conjunta</button>
      <button class="recordatorios-btn" onclick="openRemindersModal()">Recordatorios</button>
      <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <h1>MARSOL üí∞</h1>

  <div class="dashboard">
    <div class="card ingreso"><span>Ingresos</span><h2 id="totalIngresos">COP 0</h2></div>
    <div class="card gasto"><span>Gastos</span><h2 id="totalGastos">COP 0</h2></div>
    <div class="card saldo"><span>Saldo</span><h2 id="saldo">COP 0</h2></div>
  </div>

  <form id="formulario">
    <div class="segmented">
      <button type="button" id="btnIngreso" class="active">Ingreso</button>
      <button type="button" id="btnGasto">Gasto</button>
    </div>

    <input type="number" id="monto" placeholder="Monto COP" required>
    <button type="button" class="increment" id="add100">+ 100.000</button>

    <select id="catNivel1" required>
      <option value="">Categor√≠a principal</option>
    </select>

    <select id="catNivel2" required>
      <option value="">Subcategor√≠a</option>
    </select>

    <!-- Bot√≥n para tomar foto (solo visible en gastos) -->
    <button type="button" class="photo-btn" id="takePhotoBtn" onclick="openCameraModal()" style="display: none;">
      üì∏ Tomar foto de factura
    </button>
    
    <!-- Vista previa de la foto -->
    <img id="photoPreview" class="photo-preview" alt="Vista previa de foto">

    <textarea id="observacion" rows="3" placeholder="Observaciones (opcional)"></textarea>

    <button class="submit" type="submit">Registrar</button>
  </form>

  <canvas id="grafico"></canvas>

  <ul id="listaMovimientos"></ul>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
/* ===== DOM ===== */
const splash = document.getElementById("splash");
const login = document.getElementById("login");
const app = document.getElementById("app");
const loginMsg = document.getElementById("loginMsg");
const welcomeUser = document.getElementById("welcomeUser");
const notification = document.getElementById("notification");
const btnAna = document.getElementById("btnAna");
const btnCamilo = document.getElementById("btnCamilo");
const viewToggleBtn = document.getElementById("viewToggleBtn");
const userBadges = document.getElementById("userBadges");
const remindersModal = document.getElementById("remindersModal");
const remindersList = document.getElementById("remindersList");
const reminderForm = document.getElementById("reminderForm");
const reminderFilters = document.getElementById("reminderFilters");
const cameraModal = document.getElementById("cameraModal");
const cameraVideo = document.getElementById("cameraVideo");
const cameraCanvas = document.getElementById("cameraCanvas");
const capturedImage = document.getElementById("capturedImage");
const captureBtn = document.getElementById("captureBtn");
const photoActions = document.getElementById("photoActions");
const takePhotoBtn = document.getElementById("takePhotoBtn");
const photoPreview = document.getElementById("photoPreview");
const photoViewer = document.getElementById("photoViewer");
const fullSizePhoto = document.getElementById("fullSizePhoto");

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyDYD0OBJKdZ14-mvzEpN85M5_glF92WE_g",
  authDomain: "formulario-github.firebaseapp.com",
  projectId: "formulario-github",
  storageBucket: "formulario-github.appspot.com"
});
const db = firebase.firestore();
const storage = firebase.storage();

/* ===== VARIABLES GLOBALES ===== */
let currentUser = null;
let chart = null;
let appInitialized = false;
let isConjuntaView = false;
let unsubscribeListener = null;
let unsubscribeRemindersListener = null;
let currentReminderFilter = 'criticos';
let allReminders = [];
let currentPhotoBlob = null;
let cameraStream = null;
let tipo = "Ingreso"; // Variable para tipo de movimiento

/* ===== FUNCIONES UTILES ===== */
function showNotification(message, type = 'success') {
  notification.textContent = message;
  notification.style.background = type === 'success' ? '#34c759' : '#ff3b30';
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

/* ===== SPLASH ===== */
// Mostrar splash al inicio
setTimeout(() => {
  splash.style.display = "none";
  showLogin();
}, 1500);

/* ===== AUTH ===== */
const USER_NAMES = {
  ana: "Ana Mar√≠a",
  camilo: "Camilo Andr√©s"
};

const USER_COLORS = {
  ana: "#007aff",
  camilo: "#ff3b30"
};

function showSplash() {
  // Mostrar splash
  splash.style.display = "flex";
  app.style.display = "none";
  login.style.display = "none";
  
  // Ocultar splash despu√©s de 1.5 segundos y mostrar login
  setTimeout(() => {
    splash.style.display = "none";
    showLogin();
  }, 1500);
}

function showLogin() {
  login.style.display = "block";
  app.style.display = "none";
  currentUser = null;
  isConjuntaView = false;
  loginMsg.textContent = "";
  appInitialized = false;
  
  // Resetear botones de selecci√≥n
  btnAna.classList.remove('selected');
  btnCamilo.classList.remove('selected');
  
  // Destruir gr√°fico si existe
  if (chart) {
    chart.destroy();
    chart = null;
  }
  
  // Cancelar listeners anteriores si existen
  if (unsubscribeListener) {
    unsubscribeListener();
    unsubscribeListener = null;
  }
  
  if (unsubscribeRemindersListener) {
    unsubscribeRemindersListener();
    unsubscribeRemindersListener = null;
  }
}

function loginUser(user) {
  currentUser = user;
  
  // Mostrar notificaci√≥n de ingreso
  showNotification(`‚úÖ Ingresando como ${USER_NAMES[user]}`);
  
  // Ocultar login y mostrar app
  login.style.display = "none";
  app.style.display = "block";
  welcomeUser.textContent = `Bienvenido/a, ${USER_NAMES[currentUser]}`;
  
  // Actualizar badges
  updateUserBadges();
  
  // Inicializar la aplicaci√≥n si no est√° inicializada
  if (!appInitialized) {
    initializeApp();
    appInitialized = true;
  } else {
    // Si ya estaba inicializada, solo cargar los datos del usuario
    loadData();
    loadReminders();
  }
}

function logout() {
  currentUser = null;
  isConjuntaView = false;
  
  // Mostrar notificaci√≥n de cierre de sesi√≥n
  showNotification("‚úÖ Sesi√≥n cerrada correctamente");
  
  // Mostrar splash primero
  showSplash();
}

function toggleView() {
  isConjuntaView = !isConjuntaView;
  
  if (isConjuntaView) {
    viewToggleBtn.textContent = "Visual individual";
    viewToggleBtn.classList.add("conjunta");
    welcomeUser.textContent = "Visualizaci√≥n conjunta";
    showNotification("‚úÖ Visualizando datos de ambos usuarios");
  } else {
    viewToggleBtn.textContent = "Visual conjunta";
    viewToggleBtn.classList.remove("conjunta");
    welcomeUser.textContent = `Bienvenido/a, ${USER_NAMES[currentUser]}`;
    showNotification("‚úÖ Visualizando datos individuales");
  }
  
  // Actualizar badges
  updateUserBadges();
  
  // Recargar datos con la nueva vista
  loadData();
}

function updateUserBadges() {
  userBadges.innerHTML = "";
  
  if (isConjuntaView) {
    // Mostrar ambos badges en visual conjunta
    const badgeAna = document.createElement("span");
    badgeAna.className = "user-badge";
    badgeAna.textContent = "Ana Mar√≠a";
    badgeAna.style.background = "#e5f0ff";
    badgeAna.style.color = USER_COLORS.ana;
    userBadges.appendChild(badgeAna);
    
    const badgeCamilo = document.createElement("span");
    badgeCamilo.className = "user-badge";
    badgeCamilo.textContent = "Camilo Andr√©s";
    badgeCamilo.style.background = "#ffe5e5";
    badgeCamilo.style.color = USER_COLORS.camilo;
    userBadges.appendChild(badgeCamilo);
  } else {
    // Mostrar solo el badge del usuario actual
    const badge = document.createElement("span");
    badge.className = "user-badge";
    badge.textContent = USER_NAMES[currentUser];
    badge.style.background = currentUser === 'ana' ? "#e5f0ff" : "#ffe5e5";
    badge.style.color = USER_COLORS[currentUser];
    userBadges.appendChild(badge);
  }
}

/* ===== C√ÅMARA Y FOTOS ===== */
async function openCameraModal() {
  cameraModal.style.display = "flex";
  cameraVideo.style.display = "block";
  capturedImage.style.display = "none";
  photoActions.style.display = "none";
  
  try {
    // Solicitar permisos de c√°mara
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment', // Usar c√°mara trasera si est√° disponible
        width: { ideal: 1280 },
        height: { ideal: 720 }
      } 
    });
    cameraVideo.srcObject = cameraStream;
  } catch (error) {
    console.error("Error al acceder a la c√°mara:", error);
    showNotification("No se pudo acceder a la c√°mara", "error");
    closeCameraModal();
  }
}

function closeCameraModal() {
  cameraModal.style.display = "none";
  // Detener stream de c√°mara
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
}

function capturePhoto() {
  const context = cameraCanvas.getContext('2d');
  cameraCanvas.width = cameraVideo.videoWidth;
  cameraCanvas.height = cameraVideo.videoHeight;
  
  // Capturar foto del video
  context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
  
  // Convertir a blob
  cameraCanvas.toBlob((blob) => {
    currentPhotoBlob = blob;
    
    // Mostrar vista previa
    const imageUrl = URL.createObjectURL(blob);
    capturedImage.src = imageUrl;
    capturedImage.style.display = "block";
    cameraVideo.style.display = "none";
    photoActions.style.display = "block";
    
    // Limpiar stream
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
  }, 'image/jpeg', 0.8); // Calidad 80%
}

function retakePhoto() {
  capturedImage.style.display = "none";
  cameraVideo.style.display = "block";
  photoActions.style.display = "none";
  openCameraModal(); // Reabrir c√°mara
}

function usePhoto() {
  if (currentPhotoBlob) {
    const imageUrl = URL.createObjectURL(currentPhotoBlob);
    photoPreview.src = imageUrl;
    photoPreview.style.display = "block";
    closeCameraModal();
    showNotification("‚úÖ Foto capturada correctamente");
  }
}

function openPhotoViewer(photoUrl) {
  fullSizePhoto.src = photoUrl;
  photoViewer.style.display = "flex";
}

function closePhotoViewer() {
  photoViewer.style.display = "none";
}

async function uploadPhotoToStorage(blob) {
  try {
    const fileName = `facturas/${currentUser}/${Date.now()}.jpg`;
    const storageRef = storage.ref();
    const photoRef = storageRef.child(fileName);
    
    // Subir la foto
    await photoRef.put(blob);
    
    // Obtener URL de descarga
    const downloadURL = await photoRef.getDownloadURL();
    return downloadURL;
  } catch (error) {
    console.error("Error al subir foto:", error);
    throw error;
  }
}

/* ===== MODAL RECORDATORIOS ===== */
function openRemindersModal() {
  remindersModal.style.display = "flex";
  // Establecer fecha m√≠nima como hoy
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('reminderDueDate').min = today;
  loadReminders();
}

function closeRemindersModal() {
  remindersModal.style.display = "none";
  // Limpiar formulario
  reminderForm.reset();
}

// Cerrar modal al hacer clic fuera del contenido
remindersModal.addEventListener('click', function(e) {
  if (e.target === remindersModal) {
    closeRemindersModal();
  }
});

cameraModal.addEventListener('click', function(e) {
  if (e.target === cameraModal) {
    closeCameraModal();
  }
});

/* ===== FILTROS DE RECORDATORIOS ===== */
function filterReminders(filterType) {
  // Actualizar botones activos
  const filterButtons = reminderFilters.querySelectorAll('.filter-btn');
  filterButtons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  currentReminderFilter = filterType;
  renderReminders();
}

/* ===== L√ìGICA DE RECORDATORIOS ===== */
function loadReminders() {
  // Cancelar listener anterior si existe
  if (unsubscribeRemindersListener) {
    unsubscribeRemindersListener();
    unsubscribeRemindersListener = null;
  }
  
  // Obtener recordatorios de ambos usuarios
  const query = db.collection("recordatorios")
    .orderBy("fecha", "desc");
  
  unsubscribeRemindersListener = query.onSnapshot((snapshot) => {
    allReminders = [];
    snapshot.forEach((doc) => {
      const reminder = {
        id: doc.id,
        ...doc.data()
      };
      
      // Convertir fechas si es necesario
      if (reminder.fecha && reminder.fecha.toDate) {
        reminder.fecha = reminder.fecha.toDate();
      }
      
      if (reminder.fechaVencimiento && reminder.fechaVencimiento.toDate) {
        reminder.fechaVencimiento = reminder.fechaVencimiento.toDate();
      }
      
      allReminders.push(reminder);
    });
    
    renderReminders();
  }, (error) => {
    console.error("Error en la consulta de recordatorios:", error);
    showNotification("Error al cargar recordatorios", "error");
  });
}

function getReminderStatus(reminder) {
  if (!reminder.fechaVencimiento) {
    return 'sinFecha';
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const dueDate = new Date(reminder.fechaVencimiento);
  dueDate.setHours(0, 0, 0, 0);
  
  const diffTime = dueDate - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return 'vencido';
  } else if (diffDays <= 3) {
    return 'proximo';
  } else {
    return 'normal';
  }
}

function sortRemindersByCriticality(reminders) {
  return reminders.sort((a, b) => {
    // Primero: vencidos primero
    const statusA = getReminderStatus(a);
    const statusB = getReminderStatus(b);
    
    const priorityOrder = {
      'vencido': 0,
      'proximo': 1,
      'normal': 2,
      'sinFecha': 3
    };
    
    if (priorityOrder[statusA] !== priorityOrder[statusB]) {
      return priorityOrder[statusA] - priorityOrder[statusB];
    }
    
    // Segundo: si ambos tienen fecha, m√°s cercana primero
    if (a.fechaVencimiento && b.fechaVencimiento) {
      return a.fechaVencimiento - b.fechaVencimiento;
    }
    
    // Tercero: los que tienen fecha antes que los que no
    if (a.fechaVencimiento && !b.fechaVencimiento) {
      return -1;
    }
    if (!a.fechaVencimiento && b.fechaVencimiento) {
      return 1;
    }
    
    // Cuarto: por fecha de creaci√≥n (m√°s recientes primero)
    return b.fecha - a.fecha;
  });
}

function renderReminders() {
  remindersList.innerHTML = "";
  
  if (allReminders.length === 0) {
    remindersList.innerHTML = `
      <div class="empty-reminders">
        <p>üìù No hay recordatorios a√∫n</p>
        <p style="font-size: 14px; margin-top: 10px;">¬°Agrega tu primer recordatorio!</p>
      </div>
    `;
    return;
  }
  
  let filteredReminders = [...allReminders];
  
  // Aplicar filtro
  switch(currentReminderFilter) {
    case 'vencidos':
      filteredReminders = filteredReminders.filter(r => getReminderStatus(r) === 'vencido');
      break;
    case 'proximos':
      filteredReminders = filteredReminders.filter(r => getReminderStatus(r) === 'proximo');
      break;
    case 'sinFecha':
      filteredReminders = filteredReminders.filter(r => getReminderStatus(r) === 'sinFecha');
      break;
    case 'criticos':
      // Para "M√°s cr√≠ticos" ordenamos por criticidad
      filteredReminders = sortRemindersByCriticality(filteredReminders);
      break;
    case 'todos':
      // Para "Todos" mostramos por fecha de creaci√≥n
      filteredReminders.sort((a, b) => b.fecha - a.fecha);
      break;
  }
  
  if (filteredReminders.length === 0) {
    remindersList.innerHTML = `
      <div class="empty-reminders">
        <p>üìù No hay recordatorios con este filtro</p>
        <p style="font-size: 14px; margin-top: 10px;">Intenta con otro filtro</p>
      </div>
    `;
    return;
  }
  
  // Renderizar recordatorios filtrados
  filteredReminders.forEach((recordatorio) => {
    const fechaCreacion = recordatorio.fecha;
    const fechaVencimiento = recordatorio.fechaVencimiento;
    
    const fechaCreacionFormateada = fechaCreacion.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
    
    const fechaVencimientoFormateada = fechaVencimiento ? 
      fechaVencimiento.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      }) : 'Sin fecha l√≠mite';
    
    // Determinar estado
    const status = getReminderStatus(recordatorio);
    const statusClass = status === 'vencido' ? 'vencido' : 
                       status === 'proximo' ? 'proximo' : 
                       status === 'normal' ? 'normal' : 'normal';
    
    // Icono seg√∫n el tipo
    let icono = "üìå";
    switch(recordatorio.tipo) {
      case "Casa": icono = "üè†"; break;
      case "Estudio": icono = "üìö"; break;
      case "Trabajo": icono = "üíº"; break;
      case "Familia": icono = "üë®‚Äçüë©‚Äçüëß‚Äçüë¶"; break;
      case "Viaje": icono = "‚úàÔ∏è"; break;
      case "Entretenimiento": icono = "üé¨"; break;
      case "Salud": icono = "üè•"; break;
      case "Finanzas": icono = "üí∞"; break;
      default: icono = "üìå";
    }
    
    // Calcular d√≠as restantes
    let daysInfo = '';
    if (fechaVencimiento) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueDate = new Date(fechaVencimiento);
      dueDate.setHours(0, 0, 0, 0);
      const diffTime = dueDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) {
        daysInfo = `Vencido hace ${Math.abs(diffDays)} d√≠a${Math.abs(diffDays) !== 1 ? 's' : ''}`;
      } else if (diffDays === 0) {
        daysInfo = "Vence hoy";
      } else if (diffDays === 1) {
        daysInfo = "Vence ma√±ana";
      } else {
        daysInfo = `${diffDays} d√≠as restantes`;
      }
    }
    
    const reminderItem = document.createElement("div");
    reminderItem.className = `reminder-item ${statusClass}`;
    reminderItem.innerHTML = `
      <div class="reminder-header">
        <div>
          <span class="reminder-type">${icono} ${recordatorio.tipo}</span>
        </div>
        <div class="reminder-dates">
          <div class="reminder-date">Creado: ${fechaCreacionFormateada}</div>
          <div class="reminder-due-date ${statusClass}">
            ${fechaVencimiento ? `Vence: ${fechaVencimientoFormateada}` : 'Sin fecha l√≠mite'}
            ${daysInfo ? `<br><small>${daysInfo}</small>` : ''}
          </div>
        </div>
      </div>
      <div class="reminder-text">${recordatorio.texto}</div>
      <div class="reminder-footer">
        <small style="color: #666;">Por: ${recordatorio.usuarioNombre}</small>
        <button class="delete-reminder" onclick="deleteReminder('${recordatorio.id}')">Eliminar</button>
      </div>
    `;
    
    remindersList.appendChild(reminderItem);
  });
}

async function deleteReminder(reminderId) {
  if (confirm("¬øEst√°s seguro de que quieres eliminar este recordatorio?")) {
    try {
      await db.collection("recordatorios").doc(reminderId).delete();
      showNotification("‚úÖ Recordatorio eliminado correctamente");
    } catch (error) {
      console.error("Error al eliminar recordatorio:", error);
      showNotification("Error al eliminar recordatorio", "error");
    }
  }
}

/* ===== ELIMINACI√ìN "BLANDA" DE MOVIMIENTOS ===== */
async function toggleMovementActive(movimientoId, estaActivo) {
  try {
    if (estaActivo) {
      // Marcar como eliminado
      await db.collection("movimientos").doc(movimientoId).update({
        activo: false,
        eliminadoEn: firebase.firestore.FieldValue.serverTimestamp()
      });
      showNotification("‚úÖ Movimiento marcado como eliminado");
    } else {
      // Restaurar movimiento
      await db.collection("movimientos").doc(movimientoId).update({
        activo: true,
        eliminadoEn: null
      });
      showNotification("‚úÖ Movimiento restaurado");
    }
  } catch (error) {
    console.error("Error al cambiar estado del movimiento:", error);
    showNotification("Error al procesar el movimiento", "error");
  }
}

/* ===== L√ìGICA DE LA APLICACI√ìN ===== */
function initializeApp() {
  /* ---------- CATEGORIAS ---------- */
  const categoriasIngresos = {
    "Ingresos": ["N√≥mina", "Prima", "Cesant√≠as", "Cadena"]
  };

  const categoriasGastos = {
    "Servicios": ["Agua", "Energ√≠a", "Gas", "Internet", "Telefon√≠a m√≥vil"],
    "Mercado": ["Carnes", "Frutas", "L√°cteos", "Panader√≠a", "Bebidas", "Snacks"],
    "Transporte": ["Gasolina", "Transporte p√∫blico", "Taxi / Apps", "Moto"],
    "Salud": ["Medicamentos", "Consultas", "Ex√°menes"],
    "Educaci√≥n": ["Matr√≠culas", "Diplomados"],
    "Ocio": ["Cine", "Viajes", "Restaurantes"],
    "Finanzas": ["Tarjetas", "Pr√©stamos", "Ahorro", "Inversiones"],
    "Otros": ["No clasificado"]
  };

  const cat1 = document.getElementById("catNivel1");
  const cat2 = document.getElementById("catNivel2");

  /* ---------- UI ---------- */
  tipo = "Ingreso";

  function cargarCategorias() {
    cat1.innerHTML = '<option value="">Categor√≠a principal</option>';
    cat2.innerHTML = '<option value="">Subcategor√≠a</option>';

    const origen = tipo === "Ingreso" ? categoriasIngresos : categoriasGastos;
    Object.keys(origen).forEach(c => {
      cat1.innerHTML += `<option value="${c}">${c}</option>`;
    });

    cat1.onchange = () => {
      cat2.innerHTML = '<option value="">Subcategor√≠a</option>';
      if (origen[cat1.value]) {
        origen[cat1.value].forEach(s => {
          cat2.innerHTML += `<option value="${s}">${s}</option>`;
        });
      }
    };
  }

  document.getElementById("btnIngreso").onclick = () => {
    tipo = "Ingreso";
    document.getElementById("btnIngreso").classList.add("active");
    document.getElementById("btnGasto").classList.remove("active");
    // Ocultar bot√≥n de foto para ingresos
    takePhotoBtn.style.display = "none";
    cargarCategorias();
  };

  document.getElementById("btnGasto").onclick = () => {
    tipo = "Gasto";
    document.getElementById("btnGasto").classList.add("active");
    document.getElementById("btnIngreso").classList.remove("active");
    // Mostrar bot√≥n de foto para gastos
    takePhotoBtn.style.display = "block";
    cargarCategorias();
  };

  document.getElementById("add100").onclick = () => {
    const montoInput = document.getElementById("monto");
    const currentValue = parseInt(montoInput.value) || 0;
    montoInput.value = currentValue + 100000;
  };

  cargarCategorias();

  /* ---------- REGISTRO DE MOVIMIENTOS ---------- */
  document.getElementById("formulario").onsubmit = async (e) => {
    e.preventDefault();

    // Verificar que el usuario est√© autenticado
    if (!currentUser) {
      showNotification("Debes iniciar sesi√≥n para registrar movimientos", "error");
      return;
    }

    // Obtener valores del formulario
    const monto = document.getElementById("monto").value;
    const catNivel1 = cat1.value;
    const catNivel2 = cat2.value;
    const observacion = document.getElementById("observacion").value;

    // Validaciones
    if (!monto || monto <= 0) {
      showNotification("Ingresa un monto v√°lido", "error");
      return;
    }
    if (!catNivel1 || !catNivel2) {
      showNotification("Selecciona ambas categor√≠as", "error");
      return;
    }

    try {
      // Preparar datos para guardar
      const movimientoData = {
        tipo,
        monto: Number(monto),
        categoriaNivel1: catNivel1,
        categoriaNivel2: catNivel2,
        observacion: observacion,
        usuario: currentUser,
        usuarioNombre: USER_NAMES[currentUser],
        fecha: firebase.firestore.FieldValue.serverTimestamp(),
        activo: true, // Por defecto, todos los movimientos est√°n activos
        tieneFoto: false
      };

      // Si hay foto, subirla a Firebase Storage
      if (currentPhotoBlob && tipo === "Gasto") {
        const photoUrl = await uploadPhotoToStorage(currentPhotoBlob);
        movimientoData.fotoURL = photoUrl;
        movimientoData.tieneFoto = true;
        
        // Limpiar foto actual
        currentPhotoBlob = null;
        photoPreview.style.display = "none";
        photoPreview.src = "";
      }

      // Guardar en Firestore
      await db.collection("movimientos").add(movimientoData);

      // Mostrar notificaci√≥n de √©xito
      showNotification(`‚úÖ ${tipo} registrado correctamente: COP ${Number(monto).toLocaleString()}`);

      // Limpiar formulario
      document.getElementById("formulario").reset();
      cargarCategorias();
      
      // Ocultar bot√≥n de foto si no es gasto
      if (tipo !== "Gasto") {
        takePhotoBtn.style.display = "none";
      }

    } catch (error) {
      console.error("Error al guardar:", error);
      showNotification("Error al guardar el movimiento: " + error.message, "error");
    }
  };

  /* ---------- REGISTRO DE RECORDATORIOS ---------- */
  reminderForm.onsubmit = async (e) => {
    e.preventDefault();

    // Verificar que el usuario est√© autenticado
    if (!currentUser) {
      showNotification("Debes iniciar sesi√≥n para registrar recordatorios", "error");
      return;
    }

    // Obtener valores del formulario
    const reminderType = document.getElementById("reminderType").value;
    const reminderText = document.getElementById("reminderText").value;
    const reminderDueDate = document.getElementById("reminderDueDate").value;

    // Validaciones
    if (!reminderType) {
      showNotification("Selecciona un tipo de recordatorio", "error");
      return;
    }
    if (!reminderText || reminderText.trim() === "") {
      showNotification("Escribe el texto del recordatorio", "error");
      return;
    }

    try {
      // Preparar datos para guardar
      const reminderData = {
        tipo: reminderType,
        texto: reminderText.trim(),
        usuario: currentUser,
        usuarioNombre: USER_NAMES[currentUser],
        fecha: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Agregar fecha de vencimiento si se especific√≥
      if (reminderDueDate) {
        reminderData.fechaVencimiento = new Date(reminderDueDate);
      }

      // Guardar en Firestore
      await db.collection("recordatorios").add(reminderData);

      // Mostrar notificaci√≥n de √©xito
      showNotification("‚úÖ Observaci√≥n guardada con √©xito");

      // Limpiar formulario
      reminderForm.reset();

    } catch (error) {
      console.error("Error al guardar recordatorio:", error);
      showNotification("Error al guardar el recordatorio: " + error.message, "error");
    }
  };

  /* ---------- GRAFICO ---------- */
  const canvas = document.getElementById("grafico");
  chart = new Chart(canvas, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { 
          label: "Ingresos", 
          data: [], 
          borderColor: "#34c759", 
          backgroundColor: "rgba(52, 199, 89, 0.1)",
          borderWidth: 2,
          tension: 0.4,
          fill: true
        },
        { 
          label: "Gastos", 
          data: [], 
          borderColor: "#ff3b30", 
          backgroundColor: "rgba(255, 59, 48, 0.1)",
          borderWidth: 2,
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Evoluci√≥n de Ingresos y Gastos',
          font: {
            size: 16
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'COP ' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // Cargar datos iniciales
  loadData();
  loadReminders();
}

function loadData() {
  // Cancelar listener anterior si existe
  if (unsubscribeListener) {
    unsubscribeListener();
    unsubscribeListener = null;
  }

  let query;
  
  if (isConjuntaView) {
    // Visual conjunta: obtener datos de ambos usuarios
    query = db.collection("movimientos")
      .where("usuario", "in", ["ana", "camilo"])
      .orderBy("fecha", "desc");
  } else {
    // Visual individual: obtener datos solo del usuario actual
    query = db.collection("movimientos")
      .where("usuario", "==", currentUser)
      .orderBy("fecha", "desc");
  }

  unsubscribeListener = query.onSnapshot((snapshot) => {
    processMovementsData(snapshot);
  }, (error) => {
    console.error("Error en la consulta:", error);
    
    // Si hay error por √≠ndice, hacer consulta sin ordenar
    if (error.code === 'failed-precondition') {
      console.log("Haciendo consulta alternativa sin ordenamiento...");
      
      let alternativeQuery;
      if (isConjuntaView) {
        alternativeQuery = db.collection("movimientos")
          .where("usuario", "in", ["ana", "camilo"]);
      } else {
        alternativeQuery = db.collection("movimientos")
          .where("usuario", "==", currentUser);
      }
      
      alternativeQuery.get()
        .then((snapshot) => {
          const movimientos = [];
          snapshot.forEach(doc => {
            movimientos.push({ id: doc.id, ...doc.data() });
          });
          
          // Ordenar localmente por fecha descendente
          movimientos.sort((a, b) => {
            const fechaA = a.fecha?.toDate ? a.fecha.toDate() : new Date(a.fecha || 0);
            const fechaB = b.fecha?.toDate ? b.fecha.toDate() : new Date(b.fecha || 0);
            return fechaB - fechaA;
          });
          
          // Procesar movimientos ordenados localmente
          processMovementsArray(movimientos);
        })
        .catch(err => {
          console.error("Error en consulta alternativa:", err);
          showNotification("Error al cargar movimientos", "error");
        });
    } else {
      showNotification("Error al cargar movimientos", "error");
    }
  });
}

function processMovementsData(snapshot) {
  const movimientos = [];
  snapshot.forEach(doc => {
    movimientos.push({ id: doc.id, ...doc.data() });
  });
  processMovementsArray(movimientos);
}

function processMovementsArray(movimientos) {
  let ing = 0;
  let gas = 0;
  const map = {};
  const listaMovimientos = document.getElementById("listaMovimientos");
  
  // Limpiar lista
  listaMovimientos.innerHTML = "";

  // Si no hay movimientos
  if (movimientos.length === 0) {
    listaMovimientos.innerHTML = "<li style='text-align: center; color: #666;'>No hay movimientos registrados a√∫n</li>";
    
    // Actualizar dashboard con ceros
    document.getElementById("totalIngresos").textContent = "COP 0";
    document.getElementById("totalGastos").textContent = "COP 0";
    document.getElementById("saldo").textContent = "COP 0";
    
    // Limpiar gr√°fico
    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.data.datasets[1].data = [];
    chart.update();
    return;
  }

  // Procesar cada movimiento
  movimientos.forEach((movimiento) => {
    let fecha;
    if (movimiento.fecha && movimiento.fecha.toDate) {
      fecha = movimiento.fecha.toDate();
    } else if (movimiento.fecha) {
      fecha = new Date(movimiento.fecha);
    } else {
      fecha = new Date();
    }
    
    // Solo sumar al dashboard si el movimiento est√° activo
    const estaActivo = movimiento.activo !== false; // Por defecto true
    
    if (estaActivo) {
      const day = fecha.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      // Inicializar el d√≠a en el mapa si no existe
      if (!map[day]) {
        map[day] = { i: 0, g: 0 };
      }

      // Sumar seg√∫n el tipo (solo si est√° activo)
      if (movimiento.tipo === "Ingreso") {
        ing += movimiento.monto;
        map[day].i += movimiento.monto;
      } else {
        gas += movimiento.monto;
        map[day].g += movimiento.monto;
      }
    }

    // Formatear fecha para mostrar
    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    // Determinar icono seg√∫n categor√≠a
    let icono = "üí∞";
    if (movimiento.tipo === "Gasto") {
      if (movimiento.categoriaNivel1 === "Servicios") icono = "üí°";
      else if (movimiento.categoriaNivel1 === "Mercado") icono = "üõí";
      else if (movimiento.categoriaNivel1 === "Transporte") icono = "üöó";
      else if (movimiento.categoriaNivel1 === "Salud") icono = "üè•";
      else if (movimiento.categoriaNivel1 === "Educaci√≥n") icono = "üìö";
      else if (movimiento.categoriaNivel1 === "Ocio") icono = "üé¨";
      else if (movimiento.categoriaNivel1 === "Finanzas") icono = "üí≥";
      else icono = "üìù";
    } else {
      icono = "üíµ";
    }

    // Color del usuario
    const userColor = USER_COLORS[movimiento.usuario] || "#666";
    const userBadgeStyle = movimiento.usuario === 'ana' ? 
      "background: #e5f0ff; color: #007aff;" : 
      "background: #ffe5e5; color: #ff3b30;";

    // Crear elemento de lista
    const li = document.createElement("li");
    li.className = `${movimiento.tipo.toLowerCase()} ${!estaActivo ? 'movimiento-eliminado' : ''} ${movimiento.tieneFoto ? 'movimiento-has-photo' : ''}`;
    
    const montoClass = movimiento.tipo === 'Ingreso' ? '#34c759' : '#ff3b30';
    const montoSign = movimiento.tipo === 'Gasto' ? '-' : '+';
    
    li.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
        <span style="font-size: 20px;">${icono}</span>
        <div style="flex: 1;">
          <strong>${movimiento.categoriaNivel1} ¬∑ ${movimiento.categoriaNivel2}</strong>
          <span class="user-tag" style="${userBadgeStyle}">${movimiento.usuarioNombre}</span>
          <br>
          <span style="font-size: 18px; font-weight: bold; color: ${montoClass}">
            ${montoSign} COP ${movimiento.monto.toLocaleString()}
            ${!estaActivo ? ' <small style="color: #ff3b30;">(no contabilizado)</small>' : ''}
          </span>
        </div>
      </div>
      <small>${fechaFormateada} ¬∑ ${movimiento.observacion || "Sin observaciones"}</small>
      
      <div class="movement-actions">
        ${estaActivo ? 
          `<button class="delete-movement-btn" onclick="toggleMovementActive('${movimiento.id}', true)">
            ‚ùå No contabilizar
          </button>` : 
          `<button class="restore-movement-btn" onclick="toggleMovementActive('${movimiento.id}', false)">
            üîÑ Restaurar
          </button>`
        }
        ${movimiento.tieneFoto ? 
          `<button class="view-photo-btn" onclick="openPhotoViewer('${movimiento.fotoURL}')">
            üì∏ Ver factura
          </button>` : 
          ''
        }
      </div>
    `;
    
    // Agregar a la lista
    listaMovimientos.appendChild(li);
  });

  // Actualizar dashboard (solo con movimientos activos)
  document.getElementById("totalIngresos").textContent = `COP ${ing.toLocaleString()}`;
  document.getElementById("totalGastos").textContent = `COP ${gas.toLocaleString()}`;
  const saldo = ing - gas;
  document.getElementById("saldo").textContent = `COP ${saldo.toLocaleString()}`;
  
  // Actualizar color del saldo en el card
  const saldoCard = document.querySelector('.card.saldo');
  if (saldo < 0) {
    saldoCard.style.background = 'linear-gradient(135deg, #ff3b30, #ff6b6b)';
  } else {
    saldoCard.style.background = 'linear-gradient(135deg, #007aff, #5ac8fa)';
  }

  // Actualizar t√≠tulo del gr√°fico seg√∫n la vista
  const chartTitle = isConjuntaView ? 
    'Evoluci√≥n Conjunta de Ingresos y Gastos' : 
    `Evoluci√≥n de Ingresos y Gastos - ${USER_NAMES[currentUser]}`;
  
  chart.options.plugins.title.text = chartTitle;

  // Actualizar gr√°fico (solo con movimientos activos)
  const days = Object.keys(map);
  
  // Ordenar d√≠as cronol√≥gicamente
  const sortedDays = days.sort((a, b) => {
    const [dayA, monthA, yearA] = a.split('/').map(Number);
    const [dayB, monthB, yearB] = b.split('/').map(Number);
    const dateA = new Date(yearA, monthA - 1, dayA);
    const dateB = new Date(yearB, monthB - 1, dayB);
    return dateA - dateB;
  });

  chart.data.labels = sortedDays;
  chart.data.datasets[0].data = sortedDays.map(day => map[day].i);
  chart.data.datasets[1].data = sortedDays.map(day => map[day].g);
  chart.update();
}
</script>
</body>
</html>
