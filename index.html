<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MarSol ¬∑ Control Financiero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== VARIABLES & RESET ===== */
:root {
  --primary-dark: #232A39;
  --primary-blue: #4189ED;
  --secondary-blue: #4F60A0;
  --light-blue: #8B97A7;
  --light-gray: #F5F7FA;
  --white: #FFFFFF;
  --success: #34C759;
  --warning: #FF9500;
  --error: #FF3B30;
  --shadow: 0 8px 24px rgba(35, 42, 57, 0.08);
  --shadow-light: 0 4px 12px rgba(35, 42, 57, 0.04);
  --border-radius: 16px;
  --border-radius-sm: 12px;
  --border-radius-lg: 24px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Montserrat', sans-serif;
}

body {
  background: linear-gradient(135deg, #F5F7FA 0%, #E4E7EB 100%);
  color: var(--primary-dark);
  min-height: 100vh;
  padding: 20px;
  position: relative;
}

/* ===== TYPOGRAPHY ===== */
h1, h2, h3, h4 {
  font-weight: 600;
  letter-spacing: -0.02em;
}

p, span, small {
  font-family: 'Inter', sans-serif;
  font-weight: 400;
  line-height: 1.5;
}

/* ===== SPLASH SCREEN ===== */
#splash {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-blue) 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: var(--white);
  z-index: 9999;
  transition: opacity 0.5s ease;
}

#splash.fade-out {
  opacity: 0;
  pointer-events: none;
}

.splash-content {
  text-align: center;
  animation: fadeInUp 0.8s ease;
}

#splash h1 {
  font-size: 42px;
  font-weight: 700;
  margin-bottom: 16px;
  background: linear-gradient(135deg, #FFFFFF 0%, #E0E7FF 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#splash p {
  font-size: 16px;
  opacity: 0.9;
  font-weight: 300;
}

/* ===== LOGIN SCREEN ===== */
#login {
  display: none;
  max-width: 480px;
  margin: 0 auto;
  padding-top: 60px;
}

.login-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius-lg);
  padding: 48px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.login-header {
  text-align: center;
  margin-bottom: 40px;
}

.login-header h2 {
  font-size: 32px;
  color: var(--primary-dark);
  margin-bottom: 8px;
}

.login-header p {
  color: var(--light-blue);
  font-size: 16px;
}

.user-selection {
  display: grid;
  gap: 16px;
  margin-bottom: 32px;
}

.user-btn {
  background: var(--white);
  border: 2px solid rgba(139, 151, 167, 0.1);
  border-radius: var(--border-radius);
  padding: 20px 24px;
  font-size: 18px;
  font-weight: 500;
  color: var(--primary-dark);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-btn:hover {
  transform: translateY(-2px);
  border-color: var(--primary-blue);
  box-shadow: var(--shadow-light);
}

.user-btn.selected {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
  color: var(--white);
  border-color: transparent;
}

.user-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.user-btn:not(.selected) .user-icon {
  background: rgba(139, 151, 167, 0.1);
}

#loginMsg {
  text-align: center;
  color: var(--error);
  font-size: 14px;
  min-height: 20px;
}

/* ===== MAIN APP ===== */
#app {
  display: none;
  max-width: 1200px;
  margin: 0 auto;
}

/* ===== APP HEADER ===== */
.app-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius);
  padding: 20px 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.welcome-section h3 {
  font-size: 20px;
  color: var(--primary-dark);
  margin-bottom: 6px;
}

.user-badges {
  display: flex;
  gap: 8px;
}

.user-badge {
  background: rgba(65, 137, 237, 0.1);
  color: var(--primary-blue);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
}

.header-actions {
  display: flex;
  gap: 10px;
}

.action-btn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--border-radius-sm);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.view-toggle-btn {
  background: linear-gradient(135deg, var(--success) 0%, #2ECC71 100%);
  color: var(--white);
}

.view-toggle-btn.conjunta {
  background: linear-gradient(135deg, #AF52DE 0%, #9B51E0 100%);
}

.recordatorios-btn {
  background: var(--warning);
  color: var(--white);
}

.logout-btn {
  background: var(--error);
  color: var(--white);
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

/* ===== DASHBOARD CARDS (M√ÅS PEQUE√ëAS) ===== */
.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.dashboard-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius);
  padding: 20px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.dashboard-card:hover {
  transform: translateY(-3px);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.card-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.ingreso .card-icon {
  background: rgba(52, 199, 89, 0.1);
  color: var(--success);
}

.gasto .card-icon {
  background: rgba(255, 59, 48, 0.1);
  color: var(--error);
}

.saldo .card-icon {
  background: rgba(65, 137, 237, 0.1);
  color: var(--primary-blue);
}

.card-header span {
  font-size: 14px;
  color: var(--light-blue);
  font-weight: 500;
}

.card-amount {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.card-trend {
  font-size: 12px;
  color: var(--light-blue);
  margin-top: auto;
}

/* ===== MAIN CONTENT GRID ===== */
.content-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 32px;
}

@media (max-width: 1024px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
}

/* ===== FORM CARD ===== */
.form-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius);
  padding: 28px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.form-card h2 {
  font-size: 20px;
  margin-bottom: 20px;
  color: var(--primary-dark);
}

.segmented-control {
  display: flex;
  background: rgba(139, 151, 167, 0.1);
  border-radius: var(--border-radius-sm);
  padding: 4px;
  margin-bottom: 20px;
}

.segmented-btn {
  flex: 1;
  padding: 12px;
  border: none;
  background: none;
  border-radius: 10px;
  font-weight: 600;
  color: var(--light-blue);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
}

.segmented-btn.active {
  background: var(--white);
  color: var(--primary-dark);
  box-shadow: var(--shadow-light);
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: var(--primary-dark);
  font-size: 13px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 14px;
  background: rgba(139, 151, 167, 0.05);
  border: 2px solid rgba(139, 151, 167, 0.1);
  border-radius: var(--border-radius-sm);
  font-size: 14px;
  color: var(--primary-dark);
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-blue);
  background: var(--white);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.quick-amounts {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.quick-amount-btn {
  flex: 1;
  padding: 10px;
  background: rgba(65, 137, 237, 0.1);
  border: 2px solid rgba(65, 137, 237, 0.2);
  border-radius: var(--border-radius-sm);
  color: var(--primary-blue);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 13px;
}

.quick-amount-btn:hover {
  background: var(--primary-blue);
  color: var(--white);
}

.photo-section {
  margin-bottom: 20px;
}

.photo-btn {
  width: 100%;
  padding: 14px;
  background: rgba(52, 199, 89, 0.1);
  border: 2px solid rgba(52, 199, 89, 0.2);
  border-radius: var(--border-radius-sm);
  color: var(--success);
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s ease;
  font-size: 14px;
}

.photo-btn:hover {
  background: var(--success);
  color: var(--white);
}

.photo-preview {
  width: 100%;
  height: 180px;
  border-radius: var(--border-radius-sm);
  object-fit: cover;
  margin-top: 14px;
  display: none;
  border: 2px solid rgba(139, 151, 167, 0.1);
}

.submit-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
  border: none;
  border-radius: var(--border-radius-sm);
  color: var(--white);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

/* ===== CHART CARD ===== */
.chart-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius);
  padding: 28px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.chart-header h2 {
  font-size: 20px;
  color: var(--primary-dark);
}

.chart-container {
  height: 280px;
  position: relative;
}

/* ===== MOVEMENTS LIST ===== */
.movements-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius);
  padding: 28px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
  grid-column: 1 / -1;
}

.movements-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.movements-header h2 {
  font-size: 20px;
  color: var(--primary-dark);
}

.filter-controls {
  display: flex;
  gap: 8px;
}

.filter-btn {
  padding: 6px 14px;
  background: rgba(139, 151, 167, 0.1);
  border: none;
  border-radius: 20px;
  color: var(--light-blue);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
}

.filter-btn.active {
  background: var(--primary-blue);
  color: var(--white);
}

.movements-list {
  max-height: 500px;
  overflow-y: auto;
  padding-right: 8px;
}

.movement-item {
  background: rgba(245, 247, 250, 0.5);
  border-radius: var(--border-radius-sm);
  padding: 18px;
  margin-bottom: 10px;
  border-left: 4px solid transparent;
  transition: all 0.3s ease;
}

.movement-item:hover {
  transform: translateX(4px);
  background: var(--white);
}

.movement-item.ingreso {
  border-left-color: var(--success);
}

.movement-item.gasto {
  border-left-color: var(--error);
}

.movement-item.movimiento-eliminado {
  opacity: 0.6;
  border-left-color: var(--light-blue);
}

.movement-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.movement-info h4 {
  font-size: 16px;
  margin-bottom: 4px;
}

.movement-category {
  color: var(--light-blue);
  font-size: 13px;
}

.movement-amount {
  font-size: 18px;
  font-weight: 700;
}

.ingreso .movement-amount {
  color: var(--success);
}

.gasto .movement-amount {
  color: var(--error);
}

.movement-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid rgba(139, 151, 167, 0.1);
}

.movement-meta {
  display: flex;
  gap: 14px;
}

.movement-date, .movement-user {
  color: var(--light-blue);
  font-size: 13px;
}

.movement-actions {
  display: flex;
  gap: 6px;
}

.action-icon-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(139, 151, 167, 0.1);
  color: var(--light-blue);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 14px;
}

.action-icon-btn:hover {
  background: var(--primary-blue);
  color: var(--white);
}

.delete-btn:hover {
  background: var(--error);
}

.restore-btn:hover {
  background: var(--success);
}

.photo-btn-small:hover {
  background: var(--warning);
}

/* ===== MODALES ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(35, 42, 57, 0.8);
  backdrop-filter: blur(8px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.modal {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius-lg);
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
  animation: modalSlideIn 0.3s ease;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 28px;
  border-bottom: 1px solid rgba(139, 151, 167, 0.1);
}

.modal-header h2 {
  font-size: 20px;
  color: var(--primary-dark);
}

.close-modal {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(139, 151, 167, 0.1);
  color: var(--light-blue);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 20px;
}

.close-modal:hover {
  background: var(--error);
  color: var(--white);
}

.modal-body {
  padding: 28px;
}

/* ===== NOTIFICACIONES (NUEVO DISE√ëO - CENTRO INFERIOR) ===== */
.notification {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius-sm);
  padding: 12px 20px;
  box-shadow: 0 4px 20px rgba(35, 42, 57, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.2);
  z-index: 1000;
  display: none;
  align-items: center;
  gap: 10px;
  max-width: 320px;
  width: 90%;
  animation: slideUpFromBottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  border-top: 3px solid transparent;
}

.notification.success {
  border-top-color: var(--success);
}

.notification.error {
  border-top-color: var(--error);
}

.notification.warning {
  border-top-color: var(--warning);
}

.notification-icon {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}

.notification.success .notification-icon {
  background: rgba(52, 199, 89, 0.1);
  color: var(--success);
}

.notification.error .notification-icon {
  background: rgba(255, 59, 48, 0.1);
  color: var(--error);
}

.notification.warning .notification-icon {
  background: rgba(255, 149, 0, 0.1);
  color: var(--warning);
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-content p {
  font-weight: 500;
  font-size: 13px;
  margin: 0;
  color: var(--primary-dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.notification-content small {
  color: var(--light-blue);
  font-size: 11px;
  display: block;
  margin-top: 2px;
}

.notification-close {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: none;
  background: rgba(139, 151, 167, 0.1);
  color: var(--light-blue);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 12px;
  flex-shrink: 0;
  margin-left: 5px;
}

.notification-close:hover {
  background: var(--error);
  color: var(--white);
}

/* ===== ANIMACIONES ===== */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(40px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes slideUpFromBottom {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(100px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

@keyframes slideDownToBottom {
  from {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  to {
    opacity: 0;
    transform: translateX(-50%) translateY(100px);
  }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: rgba(139, 151, 167, 0.1);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(139, 151, 167, 0.3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 151, 167, 0.5);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .content-grid {
    gap: 16px;
  }
  
  .dashboard {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  
  .dashboard-card {
    padding: 16px;
  }
  
  .card-amount {
    font-size: 20px;
  }
  
  .header-actions {
    flex-direction: column;
    width: 100%;
  }
  
  .action-btn {
    width: 100%;
    justify-content: center;
  }
  
  .movements-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .filter-controls {
    width: 100%;
    overflow-x: auto;
    padding-bottom: 6px;
  }
  
  .notification {
    width: 95%;
    max-width: 280px;
    padding: 10px 16px;
  }
}
</style>
</head>

<body>

<!-- NOTIFICACI√ìN (NUEVO DISE√ëO) -->
<div class="notification" id="notification">
  <div class="notification-icon" id="notificationIcon">‚úì</div>
  <div class="notification-content">
    <p id="notificationTitle">¬°√âxito!</p>
    <small id="notificationMessage">Operaci√≥n completada correctamente</small>
  </div>
  <button class="notification-close" onclick="closeNotification()">√ó</button>
</div>

<!-- MODAL C√ÅMARA -->
<div class="modal-overlay" id="cameraModal">
  <div class="modal">
    <div class="modal-header">
      <h2>üì∏ Capturar Factura</h2>
      <button class="close-modal" onclick="closeCameraModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="camera-container">
        <video id="cameraVideo" autoplay playsinline style="width: 100%; border-radius: 12px; background: #000;"></video>
        <canvas id="cameraCanvas" style="display:none"></canvas>
        <img id="capturedImage" alt="Foto capturada" style="width: 100%; border-radius: 12px; display: none;">
        
        <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
          <button class="action-btn" style="background: var(--primary-blue);" id="captureBtn" onclick="capturePhoto()">
            Capturar Foto
          </button>
        </div>
        
        <div style="margin-top: 20px; display: none; text-align: center;" id="photoActions">
          <button class="action-btn" style="background: var(--light-blue); margin-right: 10px;" onclick="retakePhoto()">Tomar Otra</button>
          <button class="action-btn" style="background: var(--success);" onclick="usePhoto()">Usar Esta Foto</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL RECORDATORIOS -->
<div class="modal-overlay" id="remindersModal">
  <div class="modal">
    <div class="modal-header">
      <h2>üìù Recordatorios</h2>
      <button class="close-modal" onclick="closeRemindersModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="reminderForm">
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="reminderType" required>
            <option value="">Selecciona un tipo</option>
            <option value="Casa">üè† Casa</option>
            <option value="Estudio">üìö Estudio</option>
            <option value="Trabajo">üíº Trabajo</option>
            <option value="Familia">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</option>
            <option value="Viaje">‚úàÔ∏è Viaje</option>
            <option value="Entretenimiento">üé¨ Entretenimiento</option>
            <option value="Salud">üè• Salud</option>
            <option value="Finanzas">üí∞ Finanzas</option>
            <option value="Otro">üìå Otro</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Texto del Recordatorio</label>
          <textarea class="form-textarea" id="reminderText" rows="4" placeholder="Escribe tu recordatorio aqu√≠..." required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Fecha de Vencimiento (Opcional)</label>
          <input type="date" class="form-input" id="reminderDueDate" min="2024-01-01">
        </div>
        
        <button class="submit-btn" type="submit">Guardar Recordatorio</button>
      </form>
      
      <div class="filter-controls" style="margin-top: 24px;" id="reminderFilters">
        <button class="filter-btn active" onclick="filterReminders('criticos')">M√°s Cr√≠ticos</button>
        <button class="filter-btn" onclick="filterReminders('todos')">Todos</button>
        <button class="filter-btn" onclick="filterReminders('vencidos')">Vencidos</button>
        <button class="filter-btn" onclick="filterReminders('proximos')">Pr√≥ximos</button>
        <button class="filter-btn" onclick="filterReminders('sinFecha')">Sin Fecha</button>
      </div>
      
      <div class="reminders-list" id="remindersList" style="margin-top: 20px; max-height: 300px; overflow-y: auto; padding: 16px; background: rgba(139, 151, 167, 0.05); border-radius: var(--border-radius-sm);">
        <!-- Los recordatorios se cargar√°n aqu√≠ -->
      </div>
    </div>
  </div>
</div>

<!-- VISOR DE FOTOS -->
<div class="modal-overlay" id="photoViewer">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h2>üìÑ Factura</h2>
      <button class="close-modal" onclick="closePhotoViewer()">√ó</button>
    </div>
    <div class="modal-body">
      <img id="fullSizePhoto" alt="Foto completa" style="width: 100%; border-radius: var(--border-radius-sm);">
    </div>
  </div>
</div>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-content">
    <h1>MarSol</h1>
    <p>Sistema de Control Financiero ¬∑ Versi√≥n 1.6</p>
  </div>
</div>

<!-- LOGIN -->
<div id="login">
  <div class="login-container">
    <div class="login-header">
      <h2>Bienvenido de Nuevo</h2>
      <p>Selecciona tu perfil para continuar</p>
    </div>
    
    <div class="user-selection">
      <button class="user-btn" id="btnAna" onclick="loginUser('ana')">
        <div class="user-icon">üë©</div>
        <div>
          <div style="font-weight: 600;">Ana Mar√≠a</div>
          <small style="opacity: 0.7;">Cuenta Personal</small>
        </div>
      </button>
      
      <button class="user-btn" id="btnCamilo" onclick="loginUser('camilo')">
        <div class="user-icon">üë®</div>
        <div>
          <div style="font-weight: 600;">Camilo Andr√©s</div>
          <small style="opacity: 0.7;">Cuenta Personal</small>
        </div>
      </button>
    </div>
    
    <p id="loginMsg"></p>
  </div>
</div>

<!-- APLICACI√ìN PRINCIPAL -->
<div id="app">
  <!-- ENCABEZADO -->
  <header class="app-header">
    <div class="header-top">
      <div class="welcome-section">
        <h3 id="welcomeUser">Bienvenido/a</h3>
        <div class="user-badges" id="userBadges"></div>
      </div>
      
      <div class="header-actions">
        <button class="action-btn view-toggle-btn" id="viewToggleBtn" onclick="toggleView()">
          <span>üë•</span>
          <span id="viewToggleText">Visual Conjunta</span>
        </button>
        <button class="action-btn recordatorios-btn" onclick="openRemindersModal()">
          <span>üìù</span>
          <span>Recordatorios</span>
        </button>
        <button class="action-btn logout-btn" onclick="logout()">
          <span>‚Ü©Ô∏è</span>
          <span>Cerrar Sesi√≥n</span>
        </button>
      </div>
    </div>
  </header>

  <!-- DASHBOARD (M√ÅS PEQUE√ëO) -->
  <div class="dashboard">
    <div class="dashboard-card ingreso">
      <div class="card-header">
        <div class="card-icon">‚Üë</div>
        <span>INGRESOS</span>
      </div>
      <div class="card-amount" id="totalIngresos">COP 0</div>
      <div class="card-trend">Ingresos totales registrados</div>
    </div>
    
    <div class="dashboard-card gasto">
      <div class="card-header">
        <div class="card-icon">‚Üì</div>
        <span>GASTOS</span>
      </div>
      <div class="card-amount" id="totalGastos">COP 0</div>
      <div class="card-trend">Gastos totales registrados</div>
    </div>
    
    <div class="dashboard-card saldo">
      <div class="card-header">
        <div class="card-icon">$</div>
        <span>SALDO</span>
      </div>
      <div class="card-amount" id="saldo">COP 0</div>
      <div class="card-trend">Saldo disponible actual</div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="content-grid">
    <!-- TARJETA DE FORMULARIO -->
    <div class="form-card">
      <h2>Registrar Movimiento</h2>
      
      <div class="segmented-control">
        <button type="button" class="segmented-btn active" id="btnIngreso">Ingreso</button>
        <button type="button" class="segmented-btn" id="btnGasto">Gasto</button>
      </div>
      
      <form id="formulario">
        <div class="form-group">
          <label class="form-label">Monto (COP)</label>
          <input type="number" class="form-input" id="monto" placeholder="0" required>
        </div>
        
        <div class="quick-amounts">
          <button type="button" class="quick-amount-btn" onclick="addAmount(50000)">+50K</button>
          <button type="button" class="quick-amount-btn" onclick="addAmount(100000)">+100K</button>
          <button type="button" class="quick-amount-btn" onclick="addAmount(200000)">+200K</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">Categor√≠a Principal</label>
          <select class="form-select" id="catNivel1" required>
            <option value="">Selecciona categor√≠a principal</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Subcategor√≠a</label>
          <select class="form-select" id="catNivel2" required>
            <option value="">Selecciona subcategor√≠a</option>
          </select>
        </div>
        
        <div class="form-group" id="photoSection" style="display: none;">
          <label class="form-label">Foto de Factura (Opcional)</label>
          <button type="button" class="photo-btn" id="takePhotoBtn" onclick="openCameraModal()">
            <span>üì∏</span>
            <span>Tomar Foto</span>
          </button>
          <img id="photoPreview" class="photo-preview" alt="Vista previa de foto">
        </div>
        
        <div class="form-group">
          <label class="form-label">Observaciones</label>
          <textarea class="form-textarea" id="observacion" placeholder="Agrega informaci√≥n adicional..."></textarea>
        </div>
        
        <button class="submit-btn" type="submit">Registrar Movimiento</button>
      </form>
    </div>

    <!-- TARJETA DE GR√ÅFICO -->
    <div class="chart-card">
      <div class="chart-header">
        <h2>Resumen Financiero</h2>
      </div>
      <div class="chart-container">
        <canvas id="grafico"></canvas>
      </div>
    </div>
  </div>

  <!-- LISTA DE MOVIMIENTOS -->
  <div class="movements-card">
    <div class="movements-header">
      <h2>Movimientos Recientes</h2>
      <div class="filter-controls">
        <button class="filter-btn active">Todos</button>
        <button class="filter-btn">Ingresos</button>
        <button class="filter-btn">Gastos</button>
        <button class="filter-btn">Activos</button>
      </div>
    </div>
    
    <div class="movements-list" id="listaMovimientos">
      <!-- Los movimientos se cargar√°n aqu√≠ -->
      <div style="text-align: center; padding: 48px; color: var(--light-blue);">
        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
        <h3 style="margin-bottom: 8px;">No hay movimientos a√∫n</h3>
        <p>Comienza registrando tu primer ingreso o gasto</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
// ===== CONFIGURACI√ìN FIREBASE =====
firebase.initializeApp({
  apiKey: "AIzaSyDYD0OBJKdZ14-mvzEpN85M5_glF92WE_g",
  authDomain: "formulario-github.firebaseapp.com",
  projectId: "formulario-github",
  storageBucket: "formulario-github.appspot.com"
});
const db = firebase.firestore();
const storage = firebase.storage();

// ===== VARIABLES GLOBALES =====
let currentUser = null;
let chart = null;
let appInitialized = false;
let isConjuntaView = false;
let unsubscribeListener = null;
let unsubscribeRemindersListener = null;
let currentReminderFilter = 'criticos';
let allReminders = [];
let currentPhotoBlob = null;
let cameraStream = null;
let tipo = "Ingreso";
let notificationTimeout = null;

// ===== FUNCIONES UTILES =====
function showNotification(message, type = 'success', duration = 3000) {
  const notification = document.getElementById('notification');
  const notificationIcon = document.getElementById('notificationIcon');
  const notificationTitle = document.getElementById('notificationTitle');
  const notificationMessage = document.getElementById('notificationMessage');
  
  // Limpiar timeout anterior si existe
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
    notificationTimeout = null;
  }
  
  // Configurar estilo seg√∫n tipo
  notification.className = `notification ${type}`;
  
  // Configurar icono seg√∫n tipo
  let icon = "‚úì";
  let title = "¬°√âxito!";
  
  switch(type) {
    case 'success':
      icon = "‚úì";
      title = "¬°√âxito!";
      break;
    case 'error':
      icon = "‚úï";
      title = "¬°Error!";
      break;
    case 'warning':
      icon = "‚ö†";
      title = "¬°Advertencia!";
      break;
  }
  
  notificationIcon.textContent = icon;
  notificationTitle.textContent = title;
  notificationMessage.textContent = message;
  
  // Mostrar notificaci√≥n
  notification.style.display = 'flex';
  notification.style.animation = 'slideUpFromBottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
  
  // Ocultar autom√°ticamente despu√©s de la duraci√≥n especificada
  notificationTimeout = setTimeout(() => {
    closeNotification();
  }, duration);
}

function closeNotification() {
  const notification = document.getElementById('notification');
  
  // Aplicar animaci√≥n de salida
  notification.style.animation = 'slideDownToBottom 0.3s ease forwards';
  
  // Ocultar despu√©s de la animaci√≥n
  setTimeout(() => {
    notification.style.display = 'none';
    // Resetear animaci√≥n para la pr√≥xima vez
    notification.style.animation = '';
  }, 300);
  
  // Limpiar timeout
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
    notificationTimeout = null;
  }
}

function addAmount(amount) {
  const montoInput = document.getElementById('monto');
  const currentValue = parseInt(montoInput.value) || 0;
  montoInput.value = currentValue + amount;
  montoInput.focus();
}

// ===== MANEJO DEL SPLASH =====
function showSplash() {
  const splash = document.getElementById('splash');
  splash.style.display = 'flex';
  splash.classList.remove('fade-out');
  
  // Ocultar otras secciones
  document.getElementById('login').style.display = 'none';
  document.getElementById('app').style.display = 'none';
  
  // Mostrar login despu√©s de 1.5 segundos
  setTimeout(() => {
    splash.classList.add('fade-out');
    setTimeout(() => {
      splash.style.display = 'none';
      showLogin();
    }, 500);
  }, 1500);
}

function showLogin() {
  document.getElementById('login').style.display = 'block';
  document.getElementById('app').style.display = 'none';
  document.getElementById('splash').style.display = 'none';
  currentUser = null;
  isConjuntaView = false;
  document.getElementById('loginMsg').textContent = "";
  appInitialized = false;
  
  // Resetear botones de selecci√≥n
  document.getElementById('btnAna').classList.remove('selected');
  document.getElementById('btnCamilo').classList.remove('selected');
  
  // Destruir gr√°fico si existe
  if (chart) {
    chart.destroy();
    chart = null;
  }
  
  // Cancelar listeners anteriores si existen
  if (unsubscribeListener) {
    unsubscribeListener();
    unsubscribeListener = null;
  }
  
  if (unsubscribeRemindersListener) {
    unsubscribeRemindersListener();
    unsubscribeRemindersListener = null;
  }
}

// ===== INICIALIZAR SPLASH AL CARGAR LA P√ÅGINA =====
window.addEventListener('DOMContentLoaded', () => {
  showSplash();
});

// ===== AUTENTICACI√ìN =====
const USER_NAMES = {
  ana: "Ana Mar√≠a",
  camilo: "Camilo Andr√©s"
};

const USER_COLORS = {
  ana: "#007aff",
  camilo: "#ff3b30"
};

function loginUser(user) {
  currentUser = user;
  
  // Resaltar bot√≥n seleccionado
  document.getElementById('btnAna').classList.remove('selected');
  document.getElementById('btnCamilo').classList.remove('selected');
  document.getElementById(`btn${user.charAt(0).toUpperCase() + user.slice(1)}`).classList.add('selected');
  
  // Mostrar notificaci√≥n
  showNotification(`Ingresando como ${USER_NAMES[user]}`, 'success');
  
  // Ocultar login y mostrar app
  document.getElementById('login').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('welcomeUser').textContent = `Bienvenido/a, ${USER_NAMES[currentUser]}`;
  
  // Actualizar badges
  updateUserBadges();
  
  // Inicializar la aplicaci√≥n si no est√° inicializada
  if (!appInitialized) {
    initializeApp();
    appInitialized = true;
  } else {
    // Si ya estaba inicializada, solo cargar los datos del usuario
    loadData();
    loadReminders();
  }
}

function logout() {
  showNotification("Sesi√≥n cerrada correctamente", 'success');
  showSplash();
}

function toggleView() {
  isConjuntaView = !isConjuntaView;
  const viewToggleBtn = document.getElementById('viewToggleBtn');
  const viewToggleText = document.getElementById('viewToggleText');
  
  if (isConjuntaView) {
    viewToggleText.textContent = "Visual Individual";
    viewToggleBtn.classList.add("conjunta");
    document.getElementById('welcomeUser').textContent = "Visualizaci√≥n Conjunta";
    showNotification("Visualizando datos de ambos usuarios", 'success');
  } else {
    viewToggleText.textContent = "Visual Conjunta";
    viewToggleBtn.classList.remove("conjunta");
    document.getElementById('welcomeUser').textContent = `Bienvenido/a, ${USER_NAMES[currentUser]}`;
    showNotification("Visualizando datos individuales", 'success');
  }
  
  // Actualizar badges
  updateUserBadges();
  
  // Recargar datos con la nueva vista
  loadData();
}

function updateUserBadges() {
  const userBadges = document.getElementById('userBadges');
  userBadges.innerHTML = "";
  
  if (isConjuntaView) {
    // Mostrar ambos badges en visual conjunta
    const badgeAna = document.createElement("span");
    badgeAna.className = "user-badge";
    badgeAna.innerHTML = 'üë© Ana Mar√≠a';
    userBadges.appendChild(badgeAna);
    
    const badgeCamilo = document.createElement("span");
    badgeCamilo.className = "user-badge";
    badgeCamilo.innerHTML = 'üë® Camilo Andr√©s';
    userBadges.appendChild(badgeCamilo);
  } else {
    // Mostrar solo el badge del usuario actual
    const badge = document.createElement("span");
    badge.className = "user-badge";
    badge.innerHTML = currentUser === 'ana' ? 'üë© Ana Mar√≠a' : 'üë® Camilo Andr√©s';
    userBadges.appendChild(badge);
  }
}

// ===== C√ÅMARA Y FOTOS =====
async function openCameraModal() {
  document.getElementById('cameraModal').style.display = 'flex';
  document.getElementById('cameraVideo').style.display = 'block';
  document.getElementById('capturedImage').style.display = 'none';
  document.getElementById('photoActions').style.display = 'none';
  
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      } 
    });
    document.getElementById('cameraVideo').srcObject = cameraStream;
  } catch (error) {
    console.error("Error accediendo a la c√°mara:", error);
    showNotification("No se pudo acceder a la c√°mara", "error");
    closeCameraModal();
  }
}

function closeCameraModal() {
  document.getElementById('cameraModal').style.display = 'none';
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
}

function capturePhoto() {
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('cameraCanvas');
  const context = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  canvas.toBlob((blob) => {
    currentPhotoBlob = blob;
    const imageUrl = URL.createObjectURL(blob);
    document.getElementById('capturedImage').src = imageUrl;
    document.getElementById('capturedImage').style.display = 'block';
    document.getElementById('cameraVideo').style.display = 'none';
    document.getElementById('photoActions').style.display = 'block';
    
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
  }, 'image/jpeg', 0.8);
}

function retakePhoto() {
  document.getElementById('capturedImage').style.display = 'none';
  document.getElementById('cameraVideo').style.display = 'block';
  document.getElementById('photoActions').style.display = 'none';
  openCameraModal();
}

function usePhoto() {
  if (currentPhotoBlob) {
    const imageUrl = URL.createObjectURL(currentPhotoBlob);
    document.getElementById('photoPreview').src = imageUrl;
    document.getElementById('photoPreview').style.display = 'block';
    closeCameraModal();
    showNotification("Foto capturada correctamente", 'success');
  }
}

function openPhotoViewer(photoUrl) {
  document.getElementById('fullSizePhoto').src = photoUrl;
  document.getElementById('photoViewer').style.display = 'flex';
}

function closePhotoViewer() {
  document.getElementById('photoViewer').style.display = 'none';
}

// ===== INICIALIZAR APLICACI√ìN =====
function initializeApp() {
  // Configurar categor√≠as
  const categoriasIngresos = {
    "Ingresos": ["N√≥mina", "Prima", "Cesant√≠as", "Cadena"]
  };

  const categoriasGastos = {
    "Servicios": ["Agua", "Energ√≠a", "Gas", "Internet", "Telefon√≠a m√≥vil"],
    "Mercado": ["Carnes", "Frutas", "L√°cteos", "Panader√≠a", "Bebidas", "Snacks"],
    "Transporte": ["Gasolina", "Transporte p√∫blico", "Taxi / Apps", "Moto"],
    "Salud": ["Medicamentos", "Consultas", "Ex√°menes"],
    "Educaci√≥n": ["Matr√≠culas", "Diplomados"],
    "Ocio": ["Cine", "Viajes", "Restaurantes"],
    "Finanzas": ["Tarjetas", "Pr√©stamos", "Ahorro", "Inversiones"],
    "Otros": ["No clasificado"]
  };

  const cat1 = document.getElementById("catNivel1");
  const cat2 = document.getElementById("catNivel2");
  
  // Configurar tipo inicial
  tipo = "Ingreso";
  
  function cargarCategorias() {
    cat1.innerHTML = '<option value="">Selecciona categor√≠a principal</option>';
    cat2.innerHTML = '<option value="">Selecciona subcategor√≠a</option>';

    const origen = tipo === "Ingreso" ? categoriasIngresos : categoriasGastos;
    Object.keys(origen).forEach(c => {
      cat1.innerHTML += `<option value="${c}">${c}</option>`;
    });

    cat1.onchange = () => {
      cat2.innerHTML = '<option value="">Selecciona subcategor√≠a</option>';
      if (origen[cat1.value]) {
        origen[cat1.value].forEach(s => {
          cat2.innerHTML += `<option value="${s}">${s}</option>`;
        });
      }
    };
  }

  // Configurar botones de tipo
  document.getElementById("btnIngreso").onclick = () => {
    tipo = "Ingreso";
    document.getElementById("btnIngreso").classList.add("active");
    document.getElementById("btnGasto").classList.remove("active");
    document.getElementById("photoSection").style.display = "none";
    cargarCategorias();
  };

  document.getElementById("btnGasto").onclick = () => {
    tipo = "Gasto";
    document.getElementById("btnGasto").classList.add("active");
    document.getElementById("btnIngreso").classList.remove("active");
    document.getElementById("photoSection").style.display = "block";
    cargarCategorias();
  };

  // Cargar categor√≠as iniciales
  cargarCategorias();

  // Configurar formulario
  document.getElementById("formulario").onsubmit = async (e) => {
    e.preventDefault();

    if (!currentUser) {
      showNotification("Debes iniciar sesi√≥n para registrar movimientos", "error");
      return;
    }

    const monto = document.getElementById("monto").value;
    const catNivel1 = cat1.value;
    const catNivel2 = cat2.value;
    const observacion = document.getElementById("observacion").value;

    if (!monto || monto <= 0) {
      showNotification("Ingresa un monto v√°lido", "error");
      return;
    }
    if (!catNivel1 || !catNivel2) {
      showNotification("Selecciona ambas categor√≠as", "error");
      return;
    }

    try {
      const movimientoData = {
        tipo,
        monto: Number(monto),
        categoriaNivel1: catNivel1,
        categoriaNivel2: catNivel2,
        observacion: observacion,
        usuario: currentUser,
        usuarioNombre: USER_NAMES[currentUser],
        fecha: firebase.firestore.FieldValue.serverTimestamp(),
        activo: true,
        tieneFoto: false
      };

      if (currentPhotoBlob && tipo === "Gasto") {
        const fileName = `facturas/${currentUser}/${Date.now()}.jpg`;
        const storageRef = storage.ref();
        const photoRef = storageRef.child(fileName);
        
        await photoRef.put(currentPhotoBlob);
        const downloadURL = await photoRef.getDownloadURL();
        
        movimientoData.fotoURL = downloadURL;
        movimientoData.tieneFoto = true;
        
        currentPhotoBlob = null;
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('photoPreview').src = '';
      }

      await db.collection("movimientos").add(movimientoData);

      showNotification(`${tipo} registrado correctamente: COP ${Number(monto).toLocaleString()}`, 'success');

      document.getElementById("formulario").reset();
      cargarCategorias();
      
      if (tipo !== "Gasto") {
        document.getElementById("photoSection").style.display = "none";
      }

    } catch (error) {
      console.error("Error al guardar:", error);
      showNotification("Error al guardar el movimiento: " + error.message, "error");
    }
  };

  // Configurar gr√°fico
  const canvas = document.getElementById("grafico");
  chart = new Chart(canvas, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { 
          label: "Ingresos", 
          data: [], 
          borderColor: "#34c759", 
          backgroundColor: "rgba(52, 199, 89, 0.1)",
          borderWidth: 2,
          tension: 0.4,
          fill: true
        },
        { 
          label: "Gastos", 
          data: [], 
          borderColor: "#ff3b30", 
          backgroundColor: "rgba(255, 59, 48, 0.1)",
          borderWidth: 2,
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Evoluci√≥n de Ingresos y Gastos',
          font: {
            size: 16
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'COP ' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // Cargar datos iniciales
  loadData();
  loadReminders();
}

// ===== CARGAR DATOS =====
function loadData() {
  if (unsubscribeListener) {
    unsubscribeListener();
  }

  let query;
  
  if (isConjuntaView) {
    query = db.collection("movimientos")
      .where("usuario", "in", ["ana", "camilo"])
      .orderBy("fecha", "desc");
  } else {
    query = db.collection("movimientos")
      .where("usuario", "==", currentUser)
      .orderBy("fecha", "desc");
  }

  unsubscribeListener = query.onSnapshot((snapshot) => {
    const movimientos = [];
    snapshot.forEach(doc => {
      movimientos.push({ id: doc.id, ...doc.data() });
    });
    processMovementsArray(movimientos);
  }, (error) => {
    console.error("Error en consulta:", error);
    showNotification("Error al cargar movimientos", "error");
  });
}

function processMovementsArray(movimientos) {
  let ing = 0;
  let gas = 0;
  const map = {};
  const listaMovimientos = document.getElementById("listaMovimientos");
  
  listaMovimientos.innerHTML = "";

  if (movimientos.length === 0) {
    listaMovimientos.innerHTML = `
      <div style="text-align: center; padding: 48px; color: var(--light-blue);">
        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
        <h3 style="margin-bottom: 8px;">No hay movimientos a√∫n</h3>
        <p>Comienza registrando tu primer ingreso o gasto</p>
      </div>
    `;
    
    document.getElementById("totalIngresos").textContent = "COP 0";
    document.getElementById("totalGastos").textContent = "COP 0";
    document.getElementById("saldo").textContent = "COP 0";
    
    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.data.datasets[1].data = [];
    chart.update();
    return;
  }

  movimientos.forEach((movimiento) => {
    let fecha;
    if (movimiento.fecha && movimiento.fecha.toDate) {
      fecha = movimiento.fecha.toDate();
    } else if (movimiento.fecha) {
      fecha = new Date(movimiento.fecha);
    } else {
      fecha = new Date();
    }
    
    const estaActivo = movimiento.activo !== false;
    
    if (estaActivo) {
      const day = fecha.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      if (!map[day]) {
        map[day] = { i: 0, g: 0 };
      }

      if (movimiento.tipo === "Ingreso") {
        ing += movimiento.monto;
        map[day].i += movimiento.monto;
      } else {
        gas += movimiento.monto;
        map[day].g += movimiento.monto;
      }
    }

    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    const li = document.createElement("div");
    li.className = `movement-item ${movimiento.tipo.toLowerCase()} ${!estaActivo ? 'movimiento-eliminado' : ''}`;
    
    li.innerHTML = `
      <div class="movement-header">
        <div class="movement-info">
          <h4>${movimiento.categoriaNivel1} ¬∑ ${movimiento.categoriaNivel2}</h4>
          <div class="movement-category">${movimiento.usuarioNombre}</div>
        </div>
        <div class="movement-amount ${movimiento.tipo.toLowerCase()}">
          ${movimiento.tipo === 'Gasto' ? '-' : '+'} COP ${movimiento.monto.toLocaleString()}
        </div>
      </div>
      <div class="movement-details">
        <div class="movement-meta">
          <span class="movement-date">${fechaFormateada}</span>
          <span class="movement-user">${movimiento.observacion || "Sin observaciones"}</span>
        </div>
        <div class="movement-actions">
          ${estaActivo ? 
            `<button class="action-icon-btn delete-btn" onclick="toggleMovementActive('${movimiento.id}', true)" title="Eliminar">üóëÔ∏è</button>` : 
            `<button class="action-icon-btn restore-btn" onclick="toggleMovementActive('${movimiento.id}', false)" title="Restaurar">‚Ü©Ô∏è</button>`
          }
          ${movimiento.tieneFoto ? 
            `<button class="action-icon-btn photo-btn-small" onclick="openPhotoViewer('${movimiento.fotoURL}')" title="Ver factura">üì∏</button>` : 
            ''
          }
        </div>
      </div>
    `;
    
    listaMovimientos.appendChild(li);
  });

  // Actualizar dashboard
  document.getElementById("totalIngresos").textContent = `COP ${ing.toLocaleString()}`;
  document.getElementById("totalGastos").textContent = `COP ${gas.toLocaleString()}`;
  const saldo = ing - gas;
  document.getElementById("saldo").textContent = `COP ${saldo.toLocaleString()}`;
  
  // Actualizar gr√°fico
  const days = Object.keys(map);
  const sortedDays = days.sort((a, b) => {
    const [dayA, monthA, yearA] = a.split('/').map(Number);
    const [dayB, monthB, yearB] = b.split('/').map(Number);
    const dateA = new Date(yearA, monthA - 1, dayA);
    const dateB = new Date(yearB, monthB - 1, dayB);
    return dateA - dateB;
  });

  chart.data.labels = sortedDays;
  chart.data.datasets[0].data = sortedDays.map(day => map[day].i);
  chart.data.datasets[1].data = sortedDays.map(day => map[day].g);
  chart.update();
}

// ===== FUNCIONES PARA RECORDATORIOS =====
async function toggleMovementActive(movimientoId, estaActivo) {
  try {
    if (estaActivo) {
      await db.collection("movimientos").doc(movimientoId).update({
        activo: false,
        eliminadoEn: firebase.firestore.FieldValue.serverTimestamp()
      });
      showNotification("Movimiento marcado como eliminado", 'success');
    } else {
      await db.collection("movimientos").doc(movimientoId).update({
        activo: true,
        eliminadoEn: null
      });
      showNotification("Movimiento restaurado", 'success');
    }
  } catch (error) {
    console.error("Error al cambiar estado del movimiento:", error);
    showNotification("Error al procesar el movimiento", "error");
  }
}

function openRemindersModal() {
  document.getElementById('remindersModal').style.display = 'flex';
  document.getElementById('reminderDueDate').min = new Date().toISOString().split('T')[0];
  loadReminders();
}

function closeRemindersModal() {
  document.getElementById('remindersModal').style.display = 'none';
  document.getElementById('reminderForm').reset();
}

// Event listeners para cerrar modales
document.getElementById('remindersModal').addEventListener('click', function(e) {
  if (e.target === this) closeRemindersModal();
});

document.getElementById('cameraModal').addEventListener('click', function(e) {
  if (e.target === this) closeCameraModal();
});

document.getElementById('photoViewer').addEventListener('click', function(e) {
  if (e.target === this) closePhotoViewer();
});

// ===== FUNCIONES PARA FILTRAR RECORDATORIOS =====
function filterReminders(filterType) {
  const filterButtons = document.querySelectorAll('#reminderFilters .filter-btn');
  filterButtons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  currentReminderFilter = filterType;
  // renderReminders(); // Esta funci√≥n se implementar√≠a si se completa la funcionalidad de recordatorios
}

function loadReminders() {
  // Funci√≥n para cargar recordatorios desde Firebase
  // Se implementar√≠a si se completa la funcionalidad de recordatorios
  console.log("Cargando recordatorios...");
}

// Configurar formulario de recordatorios
document.getElementById('reminderForm').onsubmit = async (e) => {
  e.preventDefault();

  if (!currentUser) {
    showNotification("Debes iniciar sesi√≥n para registrar recordatorios", "error");
    return;
  }

  const reminderType = document.getElementById('reminderType').value;
  const reminderText = document.getElementById('reminderText').value;
  const reminderDueDate = document.getElementById('reminderDueDate').value;

  if (!reminderType) {
    showNotification("Selecciona un tipo de recordatorio", "error");
    return;
  }
  if (!reminderText || reminderText.trim() === "") {
    showNotification("Escribe el texto del recordatorio", "error");
    return;
  }

  try {
    const reminderData = {
      tipo: reminderType,
      texto: reminderText.trim(),
      usuario: currentUser,
      usuarioNombre: USER_NAMES[currentUser],
      fecha: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (reminderDueDate) {
      reminderData.fechaVencimiento = new Date(reminderDueDate);
    }

    await db.collection("recordatorios").add(reminderData);

    showNotification("Recordatorio guardado con √©xito", 'success');

    document.getElementById('reminderForm').reset();

  } catch (error) {
    console.error("Error al guardar recordatorio:", error);
    showNotification("Error al guardar el recordatorio: " + error.message, "error");
  }
};
</script>
</body>
</html>
